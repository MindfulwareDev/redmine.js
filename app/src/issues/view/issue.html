<md-progress-linear ng-if="ctrl.loading" class="md-warn" md-mode="indeterminate"></md-progress-linear>

<md-button hide-on-scroll ng-if="ctrl.action === 'view'" class="md-fab md-fab-bottom-right md-primary" aria-label="Edit issue" ng-click="ctrl.editIssue()">
    <md-tooltip>Edit issue</md-tooltip>
    <md-icon>edit</md-icon>
</md-button>

<div ng-if="ctrl.action === 'view'" ng-show="ctrl.issue" ng-cloak layout-padding>
    <h3 class="md-subhead">
        <md-icon ng-class="ctrl.issueIconClass">{{ctrl.issueIcon}}</md-icon>
        <span>{{::ctrl.issue.tracker.name}} #{{::ctrl.issue.id}}</span>
    </h3>
    <h1 class="md-headline">{{::ctrl.issue.subject}}</h1>

    <div>
        <span class="issue-attribute">Author</span>
        <img class="issue-user-avatar" ng-if="ctrl.author.avatar" ng-src="{{ctrl.author.avatar}}" />
        <md-icon ng-if="!ctrl.author.avatar">person</md-icon>
        <span>{{::ctrl.issue.author.name}}</span>
    </div>

    <h3 class="md-subhead">Description</h3>
    <div class="issue-description" layout-padding>{{::ctrl.issue.description}}</div>

    <h3 class="md-subhead">Details</h3>
    <table>
        <tr ng-repeat="(key, item) in ctrl.issueItems">
            <td class="issue-attribute">{{key}}</td>
            <td>
                <img class="issue-user-avatar" ng-if="item.avatar" ng-src="{{item.avatar}}" />
                <md-icon ng-if="item.avatar === ''">person</md-icon>
                <span ng-if="::item.click" ng-click="item.click()">{{::item.name}}</span>
                <span ng-if="::!item.click">{{::item.name || '-'}}</span>
            </td>
        </tr>
    </table>

    <h3 class="md-subhead">Related issues</h3>
    <md-list ng-if="ctrl.issue.relations">
        <md-list-item ng-repeat="relation in ctrl.issue.relations" ng-click="ctrl.viewIssue(relation.target_issue_id)">
            <div class="md-list-item-text cut-text">{{relation.text}}</div>
            <md-divider></md-divider>
        </md-list-item>
    </md-list>

    <h3 class="md-subhead">History</h3>
    <md-card ng-repeat="journal in ctrl.issue.journals">
        <md-card-content>
            <div layout="row" class="issue-user-line">
                <img class="issue-user-avatar" ng-if="ctrl.getUserAvatar(journal.user)" ng-src="{{ctrl.getUserAvatar(journal.user)}}" />
                <md-icon ng-if="!ctrl.getUserAvatar(journal.user)">person</md-icon>
                <span>{{journal.user.name}}</span>
                <span flex></span>
                <span>{{journal.created_on | timeago}}</span>
            </div>
            <ul>
                <li ng-repeat="detail in journal.details">
                    {{detail.text || "[loading]"}}
                </li>
            </ul>
            <p class="journal-notes">{{journal.notes}}</p>
        </md-card-content>
    </md-card>

</div>

<edit-issue ng-if="ctrl.action === 'edit'"></edit-issue>
